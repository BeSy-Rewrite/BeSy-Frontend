<div class="create-order-page h-auto w-auto">
  <mat-divider class="bg-gray-400"></mat-divider>
  <div class="pt-2 z-10 -mt-8 -mx-8 mb-4">
    <app-state-display [order]="order" />
    <mat-divider class="bg-gray-400" />
  </div>

  <div
    class="w-full top-0 flex ml-auto justify-between items-center mb-1 mt-2 pb-2"
  >
    <div class="sticky top-0 z-50 flex-1">
      <button
        mat-raised-button
        color="warn"
        (click)="resetToDefault('All')"
        [disabled]="!isAnyTabEditable()"
      >
        <mat-icon iconPositionStart>restore</mat-icon>
        Alle Änderungen verwerfen
      </button>
    </div>

    <div class="flex-1 flex justify-center">
      <div
        class="flex flex-col items-center px-6 py-2 bg-white rounded-lg shadow-md border border-gray-200"
      >
        <span class="text-xs text-gray-500 uppercase tracking-wide"
          >Bestellung</span
        >
        <span class="text-lg font-bold text-gray-900">{{ orderName() }}</span>
        <span class="text-xs text-gray-400">{{ orderBesyId() }}</span>
      </div>
    </div>

    <div class="sticky top-0 z-50 flex-1 flex justify-end">
      <button
        mat-raised-button
        color="primary"
        (click)="patchOrderFromForm('All')"
        [disabled]="!isAnyTabEditable()"
      >
        <mat-icon iconPositionStart>save</mat-icon>
        Alle Änderungen speichern
      </button>
    </div>
  </div>

  <!-- Read-only status banner -->
  @if (readOnlyBannerMessage()) {
  <div
    class="w-full flex justify-center items-center py-3 px-4 mb-4 rounded-md bg-amber-100 border border-amber-400 text-amber-800"
  >
    <mat-icon class="mr-2 text-amber-600">info</mat-icon>
    <span class="text-sm font-medium">{{ readOnlyBannerMessage() }}</span>
  </div>
  }

  <mat-tab-group
    mat-stretch-tabs="true"
    mat-align-tabs="start"
    class="mb-4"
    [selectedIndex]="selectedTabIndex()"
    (selectedTabChange)="onTabIndexChange($event.index)"
  >
    <!-- General Information -->
    <mat-tab label="Allgemeine Angaben">
      <mat-divider class="tab-divider"></mat-divider>
      <div
        class="buttons sticky w-full top-0 flex ml-auto justify-between items-start mt-2"
      >
        <button
          mat-raised-button
          color="warn"
          (click)="resetToDefault('General')"
          [disabled]="!isTabEditable('General')"
        >
          Änderungen auf dieser Seite verwerfen
        </button>
        <button
          mat-raised-button
          color="primary"
          (click)="patchOrderFromForm('General')"
          [disabled]="!isTabEditable('General')"
        >
          Speichern und weiter
        </button>
      </div>
      <div class="general-info-container">
        <app-form-component
          [config]="generalFormConfig"
          [formGroup]="generalFormGroup"
          [editMode]="true"
        ></app-form-component>
        <div class="cost-center-container">
          <app-form-component
            [config]="primaryCostCenterFormConfig"
            [formGroup]="primaryCostCenterFormGroup"
            [refreshTrigger]="primaryCostCenterConfigRefreshTrigger()"
          ></app-form-component>

          <app-form-component
            [config]="secondaryCostCenterFormConfig"
            [formGroup]="secondaryCostCenterFormGroup"
            [refreshTrigger]="secondaryCostCenterConfigRefreshTrigger()"
          ></app-form-component>
        </div>
        <div class="queries-person-container">
          <app-form-component
            [config]="queriesPersonFormConfig"
            [formGroup]="queriesPersonFormGroup"
            [refreshTrigger]="queriesPersonConfigRefreshTrigger()"
          ></app-form-component>
        </div>
      </div>
    </mat-tab>

    <!-- Add Item -->
    <mat-tab label="Bestellpositionen">
      <mat-divider class="tab-divider"></mat-divider>
      <div
        class="buttons sticky w-full top-0 flex ml-auto justify-between items-start mt-2"
      >
        <button
          mat-raised-button
          color="warn"
          (click)="resetToDefault('Items')"
          [disabled]="!isTabEditable('Items')"
        >
          Änderungen auf dieser Seite verwerfen
        </button>
        <button
          mat-raised-button
          color="primary"
          (click)="patchOrderFromForm('Items')"
          [disabled]="!isTabEditable('Items')"
        >
          Speichern und weiter
        </button>
      </div>
      <div class="item-container">
        <app-form-component
          [config]="orderItemFormConfig"
          [formGroup]="orderItemFormGroup"
          [refreshTrigger]="orderItemFormConfigRefreshTrigger()"
        ></app-form-component>
        <button
          mat-raised-button
          class="mb-4 w-full"
          color="primary"
          (click)="onAddItem()"
          [disabled]="!isTabEditable('Items')"
        >
          Position hinzufügen
        </button>
        <div class="table-container">
          <app-generic-table
            [dataSource]="itemTableDataSource"
            [columns]="orderItemColumns"
            [actions]="orderItemTableActions"
          ></app-generic-table>
        </div>
      </div>
    </mat-tab>

    <!-- Main Offer and Supplier Decision Reason -->
    <mat-tab label="Hauptangebot festlegen">
      <mat-divider class="tab-divider"></mat-divider>
      <div
        class="buttons sticky w-full top-0 flex ml-auto justify-between items-start mt-2"
      >
        <button
          mat-raised-button
          color="warn"
          (click)="resetToDefault('MainOffer')"
          [disabled]="!isTabEditable('MainOffer')"
        >
          Änderungen auf dieser Seite verwerfen
        </button>
        <button
          mat-raised-button
          color="primary"
          (click)="patchOrderFromForm('MainOffer')"
          [disabled]="!isTabEditable('MainOffer')"
        >
          Speichern und weiter
        </button>
      </div>
      <div class="main-offer-tab-container">
        <!-- Main Offer -->
        <div class="main-offer-container justify-center">
          <app-form-component
            [config]="mainOfferFormConfig"
            [formGroup]="mainOfferFormGroup"
            [refreshTrigger]="mainOfferConfigRefreshTrigger()"
            (valueChanged)="onMainOfferFormGroupChanged($event)"
          ></app-form-component>
        </div>

        <!-- Supplier Decision Reason -->
        <div class="supplier-decision-reason-container justify-center mt-8">
          <app-form-component
            [config]="supplierDecisionReasonFormConfig"
            [formGroup]="supplierDecisionReasonFormGroup"
            (valueChanged)="onSupplierDecisionReasonChanged($event)"
          ></app-form-component>
        </div>
      </div>
    </mat-tab>

    <!-- Quotations -->
    <mat-tab label="Vergleichsangebote">
      <mat-divider class="tab-divider"></mat-divider>
      <div
        class="buttons sticky w-full top-0 flex ml-auto justify-between items-start mt-2"
      >
        <button
          mat-raised-button
          color="warn"
          (click)="resetToDefault('Quotations')"
          [disabled]="!isTabEditable('Quotations')"
        >
          Änderungen auf dieser Seite verwerfen
        </button>
        <button
          mat-raised-button
          color="primary"
          (click)="patchOrderFromForm('Quotations')"
          [disabled]="!isTabEditable('Quotations')"
        >
          Speichern und weiter
        </button>
      </div>
      <div class="quotation-container">
        <app-form-component
          [config]="quotationFormConfig"
          [formGroup]="quotationFormGroup"
        ></app-form-component>
        <button
          mat-raised-button
          class="w-full mb-4"
          color="primary"
          (click)="onAddQuotation()"
          [disabled]="!isTabEditable('Quotations')"
        >
          Vergleichsangebot hinzufügen
        </button>
        <div class="table-container w-full">
          <app-generic-table
            [dataSource]="quotationTableDataSource"
            [columns]="orderQuotationColumns"
            [actions]="orderQuotationTableActions"
          ></app-generic-table>
        </div>
      </div>
    </mat-tab>
    <mat-tab label="Adressdaten">
      <mat-divider class="tab-divider"></mat-divider>
      <div
        class="buttons sticky w-full top-0 flex ml-auto justify-between items-start mt-2"
      >
        <button
          mat-raised-button
          color="warn"
          (click)="resetToDefault('Addresses')"
          [disabled]="!isTabEditable('Addresses')"
        >
          Änderungen auf dieser Seite verwerfen
        </button>
        <button
          mat-raised-button
          color="primary"
          (click)="patchOrderFromForm('Addresses')"
          [disabled]="!isTabEditable('Addresses')"
        >
          Speichern und weiter
        </button>
      </div>
      <div class="address-container">
        <div class="recipient-container flex flex-col mb-4">
          <app-form-component
            [config]="deliveryPersonFormConfig"
            [formGroup]="deliveryPersonFormGroup"
            (valueChanged)="onAddressPersonSelected($event, true)"
            [refreshTrigger]="deliveryPersonConfigRefreshTrigger()"
          ></app-form-component>
        </div>
        <div class="delivery-address-container mt-4">
          @if(isTabEditable('Addresses')) {
          <mat-button-toggle-group
            name="deliveryAddressOptions"
            [(ngModel)]="deliveryAddressOption"
            (change)="onAddressOptionChanged($event.value, true)"
            [disabled]="!isTabEditable('Addresses')"
            aria-label="Addressoption auswählen"
            class="w-full flex"
          >
            <!-- -->
            @if(deliveryPersonHasExistingAddress) {
            <mat-button-toggle value="existing" class="flex-1"
              >Gespeicherte Lieferadresse</mat-button-toggle
            >
            }
            <mat-button-toggle
              value="preferred"
              [disabled]="!deliveryPersonHasPreferredAddress"
              class="flex-1"
            >
              Bevorzugte Adresse
            </mat-button-toggle>

            <mat-button-toggle value="selected" class="flex-1">
              Bestehende Adresse auswählen
            </mat-button-toggle>

            <mat-button-toggle value="new" class="flex-1">
              Neue Adresse erstellen
            </mat-button-toggle>
          </mat-button-toggle-group>
          }
          <div class="delivery-info mt-4">
            <!-- Info Text -->
            <p class="mt-2 mb-2 text-sm text-red-700">
              {{ deliveryInfoText }}
            </p>
          </div>
          <div class="spacing-container my-4"></div>
          <!-- Table for existing addresses -->
          @if (deliveryAddressOption === 'selected') {
          <div class="table-container w-full my-4">
            @if (addressTableDataSource.data.length > 0) {
            <app-generic-table
              [dataSource]="addressTableDataSource"
              [columns]="addressTableColumns"
              (rowClicked)="onAddressInTableSelected($event, true)"
            ></app-generic-table>
            } @else {
            <p class="mt-2 mb-2 text-sm text-gray-700">
              Fehler beim Laden der Adressen. Bitte versuchen Sie es später
              erneut.
            </p>
            }
          </div>
          }
          <app-form-component
            [config]="deliveryAddressFormConfig"
            [formGroup]="deliveryAddressFormGroup"
          ></app-form-component>
          @if (selectedDeliveryPerson) {
          <div class="flex flex-col">
            <label for="sameAsRecipientGroup" class="block mb-2 text-medium font-semibold text-gray-700">
              Entspricht Empfänger und Lieferadresse dem Rechnungsempfänger und
              der Rechnungsadresse?
            </label>
            <mat-radio-group
              id="sameAsRecipientGroup"
              [(ngModel)]="sameAsRecipient"
              [disabled]="!isTabEditable('Addresses')"
              class="flex space-x-4"
            >
              <mat-radio-button [value]="true">Ja</mat-radio-button>
              <mat-radio-button [value]="false">Nein</mat-radio-button>
            </mat-radio-group>
          </div>
          }
          <!-- Rechnungsadresse -->
          @if(!sameAsRecipient && selectedDeliveryPerson) {
          <div class="invoice-address-container mt-4">
            <app-form-component
              [config]="invoicePersonFormConfig"
              [formGroup]="invoicePersonFormGroup"
              (valueChanged)="onAddressPersonSelected($event, false)"
              [refreshTrigger]="invoicePersonConfigRefreshTrigger()"
            ></app-form-component>

            @if (selectedInvoicePerson && isTabEditable('Addresses')) {
            <mat-button-toggle-group
              name="invoiceAddressOptions"
              (change)="onAddressOptionChanged($event.value, false)"
              [disabled]="!isTabEditable('Addresses')"
              aria-label="Addressoption auswählen"
              [(ngModel)]="invoiceAddressOption"
              class="flex-1"
            >
              <!-- Existing Address -->
              @if(invoicePersonHasExistingAddress) {
              <mat-button-toggle value="existing" class="flex-1"
                >Gespeicherte Rechnungsadresse</mat-button-toggle
              >
              }
              <mat-button-toggle
                value="preferred"
                [disabled]="!invoicePersonHasPreferredAddress"
                class="flex-1"
              >
                Bevorzugte Adresse
              </mat-button-toggle>

              <mat-button-toggle value="selected" class="flex-1">
                Bestehende Adresse auswählen
              </mat-button-toggle>
              <mat-button-toggle value="new" class="flex-1">
                Neue Adresse erstellen
              </mat-button-toggle>
            </mat-button-toggle-group>

            <div class="invoice-info mt-4">
              <!-- Info Text -->
              <p class="mt-2 mb-2 text-sm text-red-700">
                {{ invoiceInfoText }}
              </p>
            </div>

            <!-- Table for existing addresses -->
            @if (invoiceAddressOption === 'selected') {
            <div class="table-container w-full mt-4">
              @if (addressTableDataSource.data.length > 0) {
              <app-generic-table
                [dataSource]="addressTableDataSource"
                [columns]="addressTableColumns"
                (rowClicked)="onAddressInTableSelected($event, false)"
              ></app-generic-table>
              } @else {
              <p class="mt-2 mb-2 text-sm text-gray-700">
                Fehler beim Laden der Adressen. Bitte versuchen Sie es später
                erneut.
              </p>
              }
            </div>
            }

            <app-form-component
              [config]="invoiceAddressFormConfig"
              [formGroup]="invoiceAddressFormGroup"
            ></app-form-component>
            }
          </div>
          }
        </div>
      </div>
    </mat-tab>
    <mat-tab label="Zustimmungen">
      <mat-divider class="tab-divider"></mat-divider>
      <!-- Read-only status banner -->
      @if (readOnlyBannerMessageApprovalTab()) {
      <div
        class="w-full flex justify-center items-center py-3 px-4 mb-4 rounded-md bg-amber-100 border border-amber-400 text-amber-800"
      >
        <mat-icon class="mr-2 text-amber-600">info</mat-icon>
        <span class="text-sm font-medium">{{
          readOnlyBannerMessageApprovalTab()
        }}</span>
      </div>
      }
      <div class="approval-container">
        <app-form-component
          [config]="approvalFormConfig"
          [formGroup]="approvalFormGroup"
        ></app-form-component>
        <div
          class="buttons w-full flex ml-auto justify-between items-start mt-2"
        >
          <button
            mat-raised-button
            color="warn"
            (click)="resetToDefault('Approvals')"
            [disabled]="!isTabEditable('Approvals')"
          >
            Änderungen auf dieser Seite verwerfen
          </button>
          <button
            mat-raised-button
            color="primary"
            (click)="patchOrderFromForm('Approvals')"
            [disabled]="!isTabEditable('Approvals')"
          >
            Speichern und weiter
          </button>
        </div>
      </div>
    </mat-tab>

    <mat-tab label="Dokumente">
      <mat-divider class="tab-divider"></mat-divider>
      <div class="document-container">
        <app-order-documents [order]="order"></app-order-documents>
      </div>
    </mat-tab>
  </mat-tab-group>
</div>
