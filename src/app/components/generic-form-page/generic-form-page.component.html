<div class="form-limiter mat-elevation-z8">
  <div class="container-spacing">
    <!-- Back button for edit mode -->
    <button *ngIf="editMode()" mat-icon-button aria-label="Back to all" (click)="onBack()">
      <mat-icon>arrow_back</mat-icon>
    </button>

    <h4 style="margin-top: 10px;">
      {{ editMode() ? config().title.replace('hinzufügen', 'bearbeiten') : config().title }}
    </h4>
    <mat-divider style="margin-bottom: 5px;"></mat-divider>

    <form [formGroup]="form" (ngSubmit)="onSubmit()" novalidate>
      <table class="entity-container">
        <tr *ngFor="let field of fieldsToRender()">
          <td class="entity-titles">{{ field.label }}</td>
          <td>
            <mat-form-field style="width: 80%;">
              <mat-label>{{ field.label }}</mat-label>

              <!-- Text Input -->
              <input
                *ngIf="field.type === 'text' || field.type === 'email' || field.type === 'tel'"
                matInput
                [formControlName]="field.name"
                [type]="field.type"
                [placeholder]="field.placeholder || ''"
                [required]="field.required">

              <!-- Number Input -->
              <input
                *ngIf="field.type === 'number'"
                matInput
                type="number"
                [formControlName]="field.name"
                [placeholder]="field.placeholder || ''"
                [required]="field.required">

              <!-- Date Input -->
              <input
                *ngIf="field.type === 'date'"
                matInput
                [formControlName]="field.name"
                [matDatepicker]="picker"
                (click)="picker.open()"
                [required]="field.required">
              <mat-datepicker-toggle
                *ngIf="field.type === 'date'"
                matSuffix
                [for]="picker">
                <mat-icon>calendar_today</mat-icon>
              </mat-datepicker-toggle>
              <mat-datepicker #picker></mat-datepicker>

              <!-- Select Dropdown -->
              <mat-select
                *ngIf="field.type === 'select'"
                [formControlName]="field.name"
                [required]="field.required">
                <mat-option
                  *ngFor="let option of dropdownData[field.name]"
                  [value]="field.optionValue ? option[field.optionValue] : option">
                  {{ field.optionLabel ? option[field.optionLabel] : option }}
                </mat-option>
              </mat-select>

              <!-- Error Messages -->
              <mat-error *ngIf="isFieldValid(field.name)">
                {{ getFieldError(field.name) }}
              </mat-error>
            </mat-form-field>
          </td>
        </tr>
      </table>

      <!-- Address selection/creation section for persons and suppliers -->
      <div *ngIf="config().apiEndpoint === 'persons' || config().apiEndpoint === 'suppliers'">
        <h5>Adresse</h5>
        <mat-radio-group formControlName="addressMode" aria-label="Address mode">
          <mat-radio-button value="existing">Vorhandene Adresse auswählen</mat-radio-button>
          <mat-radio-button value="new" style="margin-left: 16px;">Neue Adresse eingeben</mat-radio-button>
        </mat-radio-group>

        <!-- Existing address dropdown -->
        <div *ngIf="form.get('addressMode')?.value === 'existing'" style="margin-top: 12px;">
          <mat-form-field style="width: 80%;">
            <mat-label>Adresse</mat-label>
            <mat-select formControlName="existingAddressId">
              <mat-option *ngFor="let addr of addressesList" [value]="addr.id">
                {{ addr.street }} {{ addr.building_number }}, {{ addr.postal_code }} {{ addr.town }}
              </mat-option>
            </mat-select>
          </mat-form-field>
        </div>

        <!-- New address form fields -->
        <div *ngIf="form.get('addressMode')?.value === 'new'" style="margin-top: 12px;">
          <table class="entity-container">
            <tr>
              <td class="entity-titles">Straßenname</td>
              <td>
                <mat-form-field style="width: 80%;">
                  <mat-label>Straßenname</mat-label>
                  <input matInput formControlName="addr_street" />
                </mat-form-field>
              </td>
            </tr>
            <tr>
              <td class="entity-titles">Hausnummer</td>
              <td>
                <mat-form-field style="width: 80%;">
                  <mat-label>Hausnummer</mat-label>
                  <input matInput formControlName="addr_building_number" />
                </mat-form-field>
              </td>
            </tr>
            <tr>
              <td class="entity-titles">Stadt</td>
              <td>
                <mat-form-field style="width: 80%;">
                  <mat-label>Stadt</mat-label>
                  <input matInput formControlName="addr_town" />
                </mat-form-field>
              </td>
            </tr>
            <tr>
              <td class="entity-titles">PLZ</td>
              <td>
                <mat-form-field style="width: 80%;">
                  <mat-label>PLZ</mat-label>
                  <input matInput formControlName="addr_postal_code" />
                </mat-form-field>
              </td>
            </tr>
            <tr>
              <td class="entity-titles">Land</td>
              <td>
                <mat-form-field style="width: 80%;">
                  <mat-label>Land</mat-label>
                  <input matInput formControlName="addr_country" />
                </mat-form-field>
              </td>
            </tr>
            <tr>
              <td class="entity-titles">Region</td>
              <td>
                <mat-form-field style="width: 80%;">
                  <mat-label>Region</mat-label>
                  <input matInput formControlName="addr_county" />
                </mat-form-field>
              </td>
            </tr>
            <tr>
              <td class="entity-titles">Gebäudename</td>
              <td>
                <mat-form-field style="width: 80%;">
                  <mat-label>Gebäudename</mat-label>
                  <input matInput formControlName="addr_building_name" />
                </mat-form-field>
              </td>
            </tr>
            <tr>
              <td class="entity-titles">Kommentar</td>
              <td>
                <mat-form-field style="width: 80%;">
                  <mat-label>Kommentar</mat-label>
                  <input matInput formControlName="addr_comment" />
                </mat-form-field>
              </td>
            </tr>
          </table>
        </div>
      </div>

      <div class="buttons" style="justify-content: flex-end;">
        <button
          mat-raised-button
          type="submit"
          aria-label="save"
          style="margin-right: 8px; background-color: #193058; color: white;"
          [ngClass]="{ shake: isShaking}">
          {{ editMode() ? 'Änderungen speichern' : config().title.includes('Adresse') ? 'Adresse speichern' : 'Speichern' }}
        </button>

        <button
          *ngIf="editMode"
          mat-raised-button
          type="button"
          (click)="onBack()"
          aria-label="cancel"
          style="margin-right: 8px; background-color: red; color: white;">
          Verwerfen
        </button>

        <button
          *ngIf="!editMode"
          mat-raised-button
          type="button"
          (click)="onCancel()"
          aria-label="reset"
          style="margin-right: 8px;">
          Zurücksetzen
        </button>
      </div>
    </form>
  </div>
</div>
